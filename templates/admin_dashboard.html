<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { padding: 20px; }
  .table-actions a { margin-right: 5px; }
  .flash-message { position: fixed; top: 10px; right: 10px; z-index: 9999; min-width: 260px; }
  .small-muted { font-size: 0.9rem; color: #6c757d; }
  .no-data { padding: 2rem; color: #6c757d; border: 1px dashed #dee2e6; border-radius: 6px; text-align: center; }
  .tab-pane { min-height: 120px; }
</style>
</head>
<body>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Admin Dashboard</h2>
  <div>
    <a href="{{ url_for('recycle_bin') }}" class="btn btn-outline-secondary me-2">Recycle Bin</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-message">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
  <li class="nav-item"><button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">Users</button></li>
  <li class="nav-item"><button class="nav-link" id="nutrition-tab" data-bs-toggle="tab" data-bs-target="#nutrition" type="button">Nutrition</button></li>
  <li class="nav-item"><button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">Analytics</button></li>
  <li class="nav-item"><button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">Activity Logs</button></li>
</ul>

<div class="tab-content">

  <!-- Users Tab -->
  <div class="tab-pane fade show active" id="users">
    <div class="d-flex mb-2 gap-2">
      <input type="text" class="form-control" placeholder="Search Users..." id="userSearch">
      <div class="small-muted align-self-center">Total: {{ users|length }}</div>
    </div>
    <table class="table table-striped">
      <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Actions</th></tr></thead>
      <tbody id="userTable">
        {% for user in users %}
        <tr>
          <td>{{ user['id'] }}</td>
          <td>{{ user['username'] }}</td>
          <td>{{ user['email'] }}</td>
          <td class="table-actions">
            <a href="{{ url_for('delete_user', user_id=user['id']) }}" class="btn btn-sm btn-danger" onclick="return confirm('Move to Recycle Bin?')">Delete</a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="text-center small-muted">No active users found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Nutrition Tab -->
  <div class="tab-pane fade" id="nutrition">
    <div class="d-flex mb-2 gap-2">
      <a href="{{ url_for('add_nutrition') }}" class="btn btn-warning">+ Add Nutrition</a>
      <input type="text" class="form-control" placeholder="Search Nutrition..." id="nutritionSearch">
      <div class="small-muted align-self-center">Total: {{ nutrition|length }}</div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Calories</th>
            <th>Protein</th><th>Fat</th><th>Carbs</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="nutritionTable">
          {% for row in nutrition %}
          <tr>
            <td>{{ row['id'] }}</td>
            <td>{{ row['name'] }}</td>
            <td>{{ row['calories'] }}</td>
            <td>{{ row['protein'] }}</td>
            <td>{{ row['fat'] }}</td>
            <td>{{ row['carbs'] }}</td>
            <td class="table-actions">
              <a href="{{ url_for('edit_nutrition', id=row['id']) }}" class="btn btn-sm btn-primary">Edit</a>
              <a href="{{ url_for('delete_nutrition', item_id=row['id']) }}" class="btn btn-sm btn-danger" onclick="return confirm('Move to Recycle Bin?')">Delete</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center small-muted">No nutrition items found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Analytics Tab -->
  <div class="tab-pane fade" id="analytics">
    <h5 class="mt-3 mb-3">ðŸ“Š Nutrition Analytics</h5>
    
    <!-- Summary Cards -->
    <div class="row text-center mb-4">
      <div class="col-md-3">
        <div class="card p-3 shadow-sm">
          <h6>Total Items</h6>
          <h4>{{ nutrition|length }}</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 shadow-sm">
          <h6>Avg Calories</h6>
          <h4>{{ (nutrition|map(attribute='calories')|sum / (nutrition|length if nutrition|length>0 else 1))|round(1) }}</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 shadow-sm">
          <h6>Top Protein Food</h6>
          <h4>{% set top = nutrition|max(attribute='protein') %}{{ top['name'] if top else '-' }}</h4>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 shadow-sm">
          <h6>Lowest Fat Food</h6>
          <h4>{% set lowfat = nutrition|min(attribute='fat') %}{{ lowfat['name'] if lowfat else '-' }}</h4>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
      <div class="col-md-6 mb-4">
        <h6>Macro Distribution</h6>
        <canvas id="macroChart" style="max-height:300px;"></canvas>
      </div>
      <div class="col-md-6 mb-4">
        <h6>Active Users Over Time</h6>
        <canvas id="activeUsersChart" style="max-height:300px;"></canvas>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-4">
        <h6>Feature Usage Split</h6>
        <canvas id="featureUsageChart" style="max-height:300px;"></canvas>
      </div>
      <div class="col-md-6 mb-4">
        <h6>Daily Activity Heatmap</h6>
        <canvas id="heatmapChart" style="max-height:300px;"></canvas>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-4">
        <h6>Top Streak Users</h6>
        <canvas id="streakChart" style="max-height:300px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Activity Logs Tab -->
  <div class="tab-pane fade" id="logs">
    <h3 class="mt-3">Activity Logs</h3>
    <div class="table-responsive" style="max-height:400px; overflow-y:auto;">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Action</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td>{{ log['id'] }}</td>
            <td>{{ log['user'] or '-' }}</td>
            <td>{{ log['action'] }}</td>
            <td>{{ log['timestamp'] }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-center small-muted">No logs available.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recycle Bin Tab -->
  <div class="tab-pane fade" id="recycle">
    <h3>Deleted Users</h3>
    <table class="table table-bordered">
      <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Actions</th></tr></thead>
      <tbody>
        {% for user in deleted_users %}
        <tr>
          <td>{{ user['id'] }}</td>
          <td>{{ user['username'] }}</td>
          <td>{{ user['email'] }}</td>
          <td>
            <a href="{{ url_for('restore_user', user_id=user['id']) }}" class="btn btn-sm btn-success">Restore</a>
            <a href="{{ url_for('permanent_delete_user', user_id=user['id']) }}" class="btn btn-sm btn-danger" onclick="return confirm('Permanently delete?')">Delete Forever</a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="text-center small-muted">No deleted users.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>Deleted Nutrition Items</h3>
    <table class="table table-bordered">
      <thead>
        <tr><th>ID</th><th>Name</th><th>Calories</th><th>Protein</th><th>Fat</th><th>Carbs</th><th>Actions</th></tr>
      </thead>
      <tbody>
        {% for item in deleted_nutrition %}
        <tr>
          <td>{{ item['id'] }}</td>
          <td>{{ item['name'] }}</td>
          <td>{{ item['calories'] }}</td>
          <td>{{ item['protein'] }}</td>
          <td>{{ item['fat'] }}</td>
          <td>{{ item['carbs'] }}</td>
          <td>
            <a href="{{ url_for('restore_nutrition', item_id=item['id']) }}" class="btn btn-sm btn-success">Restore</a>
            <a href="{{ url_for('permanent_delete_nutrition', item_id=item['id']) }}" class="btn btn-sm btn-danger" onclick="return confirm('Permanently delete?')">Delete Forever</a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center small-muted">No deleted nutrition items.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function $(id){return document.getElementById(id);}

/* User Search */
const userSearch = $('userSearch');
if(userSearch){userSearch.addEventListener('keyup', function(){
  const filter = this.value.toLowerCase();
  document.querySelectorAll('#userTable tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter)?'':'none';
  });
});}

/* Nutrition Search */
const nutritionSearch = $('nutritionSearch');
if(nutritionSearch){nutritionSearch.addEventListener('keyup', function(){
  const filter = this.value.toLowerCase();
  document.querySelectorAll('#nutritionTable tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter)?'':'none';
  });
});}

/* Analytics Charts */
const nutritionData = {{ nutrition|tojson }};
function pickColors(n){
  const palette = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ac'];
  const out=[]; for(let i=0;i<n;i++) out.push(palette[i%palette.length]); return out;
}

(function buildCharts(){
  try{
    let totals = { calories:0, protein:0, fat:0, carbs:0 };
    (nutritionData || []).forEach(item=>{
      totals.calories += item.calories||0;
      totals.protein += item.protein||0;
      totals.fat += item.fat||0;
      totals.carbs += item.carbs||0;
    });

    new Chart($('macroChart'), { type:'doughnut',
      data:{ labels:["Calories","Protein","Fat","Carbs"], datasets:[{ data:[totals.calories,totals.protein,totals.fat,totals.carbs], backgroundColor:["#f28e2b","#4e79a7","#e15759","#76b7b2"] }] }
    });

    new Chart($('activeUsersChart'), { type:'line', data:{ labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"], datasets:[{ label:"Active Users", data:[5,8,12,9,15,18,10], borderColor:"#4e79a7", fill:false }] } });
    new Chart($('featureUsageChart'), { type:'pie', data:{ labels:["Scanner","Book Fortune","Healthy Recipes"], datasets:[{ data:[45,30,25], backgroundColor:["#f28e2b","#76b7b2","#e15759"] }] } });
    new Chart($('heatmapChart'), { type:'bar', data:{ labels:["Morning","Afternoon","Evening","Night"], datasets:[{ label:"Logins", data:[10,20,30,15], backgroundColor:"#17a2b8" }] } });
    new Chart($('streakChart'), { type:'bar', data:{ labels:["User1","User2","User3","User4"], datasets:[{ label:"Streak (days)", data:[7,5,3,2], backgroundColor:"#6f42c1"}] }, options:{ indexAxis:'y' } });

  }catch(e){ console.error('Chart build error', e); }
})();
</script>

</body>
</html>
